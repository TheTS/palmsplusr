---
title: "Example palmsplusr workflow"
author: "Tom Stewart"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Workflow example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


### Loading the PALMS dataset

PALMS datasets are read in as a csv file, before being converted to a spatial object (known as a "simple feature").
```{r message=FALSE, warning=FALSE}
library(palmsplusr)
library(readr)
library(sf)

palms <- read_csv(system.file("extdata", "one_participant.csv", package = "palmsplusr"))
palms <- st_as_sf(palms, coords = c("lon", "lat"), crs = 4326)
```


### Building palmsplus

The *palmsplus* build process essentially adds additional columns to the input PALMS dataset. However, *palmsplusr* needs to be told what columns to add, and how to calculate them. This is achieved by building a fields table, as demonstrated below:
```{r}
palms_add_field("duration",   "1", TRUE)
palms_add_field("weekday",    "dow < 6")
palms_add_field("weekend",    "dow > 5")
palms_add_field("indoors",    "iov == 3", TRUE)
palms_add_field("outdoors",   "iov == 1", TRUE)
palms_add_field("in_vehicle", "iov == 2")
palms_add_field("inserted",   "fixtypecode == 6")
palms_add_field("pedestrian", "tripmot == 1")
palms_add_field("bicycle",    "tripmot == 2")
palms_add_field("vehicle",    "tripmot == 3")
palmsplus_fields
```

The variables contained in the formula can be from the input palms dataset, or from other files you load in. Below is an example of reading in a shapefile, and adding a new field that checks whether a palms point is inside a polygon:
```{r}
home <- read_sf(system.file("extdata/shapefiles/", "home.shp", package = "palmsplusr"))
home.buffer <- palms_buffer(point = home, distance = 100)

palms_add_field("at_home",   "palms_in_polygon(., filter(home.buffer, identifier == i), \"identifier\")")
```

Once all of the fields have been added, you can build the *palmsplus* table.

```{r}
palmsplus <- palms_calc_palmsplus(palms)
names(palmsplus)
```

### Building days

When building the days table, the data are summarised across sereral *domains*. Domains are added in the same way fields are added. Note that domains needs to be added before palmsplus is built.

```{r}
palms_add_domain("d_home", "at_home")
palms_add_domain("d_transport", "pedestrian | bicycle | vehicle")

palmsplus <- palms_calc_palmsplus(palms)
names(palmsplus)
```

Notice there are two additional columns in the palmsplus table. These are used as aggregation domains when the *days* table is built.
```{r}
days <- palms_calc_days(palmsplus)
head(days)
```


### Building trajectories

Like previously, various fields can be calculated for each trajectory. The variables used in the formulas should be present in the palmsplus table.
```{r}
palms_add_trajectory_field("mot",       "first(tripmot)")
palms_add_trajectory_field("wear",      "sum(activityintensity >= 0) * epoch")
palms_add_trajectory_field("sedentary", "sum(activityintensity == 0) * epoch")
palms_add_trajectory_field("light",     "sum(activityintensity == 1) * epoch")
palms_add_trajectory_field("moderate",  "sum(activityintensity == 2) * epoch")
palms_add_trajectory_field("vigorous",  "sum(activityintensity == 3) * epoch")
palms_add_trajectory_field("mvpa",      "moderate + vigorous")
```


```{r}
trajectories <- palms_calc_trajectories(palmsplus)
head(trajectories)
```

It is also possible to isolate trjectories that start and end at specific locations. This is done by adding trip start end end criteria before building the trajectories table. Here is an example of trips starting and ending at home. Notice how the "in_home" criteria was created above in the palmsplus table. All the start and end criteria should be pre-calculated to improve performance.

```{r}
palms_add_trip_location("home_home", "at_home", "at_home")
trajectories <- palms_calc_trajectories(palmsplus)
head(trajectories)
```

### Summary plot
```{r}
# TODO
```


